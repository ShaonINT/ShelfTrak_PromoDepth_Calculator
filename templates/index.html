<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfTrak Promo Depth Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='table_styles.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="ShelfTrak Logo" class="logo">
            <h1>Promo Depth Calculator</h1>
            <p>Upload your Price & Promo file to calculate depths automatically.</p>
        </header>

        <div class="instructions">
            <h3>How to Prepare Your Data</h3>
            <ol>
                <li>Download the Latest Wave Data.</li>
                <li>Combine the <strong>Local Price</strong> and <strong>PromotionDetails</strong> using Concatenation
                    Function Seperated by ( - ).</li>
                <li>Rename the new Column as <strong>Price & Promo Details</strong>.</li>
                <li>Take the Price & Promo Details column to a separate sheet, go to Data tab and remove duplicates.
                </li>
                <li>Save the Price & Promo Details in a separate Excel file.</li>
                <li>Upload the Excel file below.</li>
            </ol>
        </div>

        <div class="instructions">
            <h3>Calculation Logic Examples</h3>
            <ul>
                <li><strong>Direct %:</strong> "Save 33%" → 33%</li>
                <li><strong>Buy X Get Y:</strong> "Buy 2 Get 1 Free" → 33.33% (1/3)</li>
                <li><strong>Was/Now:</strong> "Was $100 Now $80" → 20%</li>
                <li><strong>Money Off:</strong> "$10 Off" (Base $50) → 20%</li>
                <li><strong>Multi-Buy:</strong> "2 For $15" (Base $10 each) → 25%</li>
            </ul>
            <div style="margin-top: 1.5rem; text-align: center;">
                <a href="{{ url_for('static', filename='Promo_Depth_Rules.pdf') }}" class="btn-secondary"
                    download>Download Full Rules PDF</a>
            </div>
        </div>

        <main>


            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="flash-messages">
                {% for message in messages %}
                <div class="alert">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <p style="text-align: center; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    Acceptable file formats: <strong>.xlsx, .xls</strong>
                </p>
                <div style="text-align: center; margin-bottom: 1rem;">
                    <img src="{{ url_for('static', filename='images/column_example.png') }}" alt="Column Example"
                        style="max-width: 100%; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                <div class="drop-zone" id="drop-zone">
                    <span class="drop-zone__prompt">Drag & Drop file here or <span
                            class="highlight">Browse</span></span>
                    <input type="file" name="file" class="drop-zone__input" accept=".xlsx, .xls" required>
                </div>
                <button type="submit" class="btn-primary">Calculate & Download</button>
            </form>
            {% if row_count is defined %}
            <div class="results-section">
                <div class="alert" style="background-color: #dcfce7; color: #166534; border-color: #bbf7d0;">
                    <strong>Success!</strong> Calculated promo depth for <strong>{{ row_count }}</strong> rows.
                </div>

                <div class="preview-container">
                    <h3>Preview (First 50 Rows)</h3>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Price & Promo</th>
                                    <th>Promo Depth (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in preview_data %}
                                <tr>
                                    <td>{{ row['Price & Promo'] if row['Price & Promo'] else row['Price & Promo
                                        Details'] }}</td>
                                    <td>{{ row['Promo Depth'] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: center;">
                    <a href="{{ url_for('download_file', download_id=download_id) }}" class="btn-primary">Download Full
                        Excel File</a>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
            const dropZoneElement = inputElement.closest(".drop-zone");

            dropZoneElement.addEventListener("click", (e) => {
                inputElement.click();
            });

            inputElement.addEventListener("change", (e) => {
                if (inputElement.files.length) {
                    updateThumbnail(dropZoneElement, inputElement.files[0]);
                }
            });

            dropZoneElement.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZoneElement.classList.add("drop-zone--over");
            });

            ["dragleave", "dragend"].forEach((type) => {
                dropZoneElement.addEventListener(type, (e) => {
                    dropZoneElement.classList.remove("drop-zone--over");
                });
            });

            dropZoneElement.addEventListener("drop", (e) => {
                e.preventDefault();

                if (e.dataTransfer.files.length) {
                    inputElement.files = e.dataTransfer.files;
                    updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                }

                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        function updateThumbnail(dropZoneElement, file) {
            let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

            // First time - remove the prompt
            if (dropZoneElement.querySelector(".drop-zone__prompt")) {
                dropZoneElement.querySelector(".drop-zone__prompt").remove();
            }

            // First time - there is no thumbnail element, so lets create it
            if (!thumbnailElement) {
                thumbnailElement = document.createElement("div");
                thumbnailElement.classList.add("drop-zone__thumb");
                dropZoneElement.appendChild(thumbnailElement);
            }

            thumbnailElement.dataset.label = file.name;
        }
    </script>
</body>

</html>